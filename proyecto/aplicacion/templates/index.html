<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Principal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f3f4f6; overflow-x: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar {
            min-height: 100vh;
            background-color: #1e293b; 
            color: white;
            padding-top: 20px;
        }
        .sidebar h3 { font-size: 1.2rem; padding-left: 20px; margin-bottom: 30px; font-weight: bold; color: #fff;}
        .menu-item {
            padding: 15px 20px;
            color: #94a3b8;
            display: block;
            text-decoration: none;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }
        .menu-item:hover, .menu-item.active {
            background-color: #0f172a;
            color: white;
            border-left: 4px solid #3b82f6; 
        }
        .card-dashboard {
            background: white;
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .card-title { color: #64748b; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}
        .sensor-serial { font-size: 0.8rem; color: #cbd5e1; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar d-none d-md-block">
            <h3><i class="bi bi-cpu-fill"></i> ADMIN</h3>
            <a href="#" class="menu-item active"><i class="bi bi-speedometer2 me-2"></i> Tablero </a>
            <a href="/admin/" class="menu-item"><i class="bi bi-people me-2"></i> Administrar</a>
            <a href="/rest/" class="menu-item"><i class="bi bi-hdd-network me-2"></i> API Rest</a>
            
            <div style="position: absolute; bottom: 20px; left: 20px; font-size: 0.8rem; color: #555;">
                <p>Versión 1.0</p>
            </div>
        </div>

        <div class="col-md-10 p-4">
            <h2 class="mb-4">Monitor de sensores </h2>

            <div class="row" id="contenedor-graficas">
                <div class="col-12 text-center mt-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Conectando con la base de datos</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    const URL_SENSORES = '/rest/sensores/';
    const URL_MEDICIONES = '/rest/mediciones/';

    async function cargarDashboard() {
        try {
            const [resSensores, resMediciones] = await Promise.all([
                fetch(URL_SENSORES),
                fetch(URL_MEDICIONES)
            ]);

            const sensores = await resSensores.json();
            const mediciones = await resMediciones.json();
            
            const contenedor = document.getElementById('contenedor-graficas');
            contenedor.innerHTML = ''; 

            if (sensores.length === 0) {
                contenedor.innerHTML = '<div class="alert alert-warning">No hay sensores registrados. Ve al Admin y crea uno.</div>';
                return;
            }
            sensores.forEach((sensor, index) => {
                const medicionesDelSensor = mediciones.filter(m => m.sensor == sensor.id || (m.sensor.toString().includes(sensor.id)));
                const ultimaMedicion = medicionesDelSensor.pop(); 
                const valor = ultimaMedicion ? ultimaMedicion.valor : 0;
                const divId = `chart-${index}`;
                const colorGrafica = index % 2 === 0 ? '#3b82f6' : '#ef4444'; 
                const htmlTarjeta = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card-dashboard">
                            <h5 class="card-title">${sensor.nombre}</h5>
                            <p class="sensor-serial">${sensor.serial}</p>
                            
                            <div id="${divId}"></div>
                            
                            <p class="text-muted mt-2">Modelo: ${sensor.modelo}</p>
                            <span class="badge ${sensor.activo ? 'bg-success' : 'bg-secondary'}">
                                ${sensor.activo ? 'EN LÍNEA' : 'DESCONECTADO'}
                            </span>
                        </div>
                    </div>
                `;
                contenedor.innerHTML += htmlTarjeta;
                setTimeout(() => {
                    var options = {
                        series: [valor], 
                        chart: { type: 'radialBar', height: 280 },
                        plotOptions: {
                            radialBar: {
                                hollow: { size: '65%' },
                                track: { background: '#f0f0f0'},
                                dataLabels: {
                                    show: true,
                                    name: { show: false },
                                    value: {
                                        fontSize: '30px', show: true, fontWeight: 'bold',
                                        formatter: function (val) { return val } 
                                    }
                                }
                            }
                        },
                        fill: { colors: [colorGrafica] }, 
                        stroke: { lineCap: 'round' },
                        labels: ['Valor'],
                    };
                    var chart = new ApexCharts(document.querySelector("#" + divId), options);
                    chart.render();
                }, 100);
            });

        } catch (error) {
            console.error(error);
            document.getElementById('contenedor-graficas').innerHTML = 
                '<div class="alert alert-danger">Error cargando datos. Revisa si iniciaste sesión o si la API es pública.</div>';
        }
    }
    cargarDashboard();
</script>

</body>
</html>